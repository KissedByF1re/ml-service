# ML-сервис прогнозирования оттока клиентов

**ML-сервис прогнозирования оттока клиентов** — это веб-приложение, предназначенное для предсказания вероятности ухода клиента (churn) на основе его характеристик и поведения. Сервис позволяет выбирать разные модели машинного обучения в зависимости от требуемой скорости и точности прогноза, а также учитывает стоимость каждого запроса в зависимости от сложности выбранной модели (система биллинга).

## Назначение проекта

Проект нацелен на создание гибкого сервиса прогнозирования оттока клиентов, который компании могут интегрировать в свои системы для предотвращения ухода пользователей. Он автоматизирует процесс расчёта вероятности churn по данным о клиентах с возможностью выбора модели и учётом стоимости прогноза.

## Бизнес-контекст

Сервис ориентирован на компании, которым важно удержание клиентов:

- Телеком-операторы
- Банки
- Подписочные сервисы
- Ритейл и e-commerce

Прогнозирование оттока помогает таким компаниям сфокусировать маркетинговые усилия на удержании клиентов с высоким риском ухода, что напрямую влияет на выручку и лояльность аудитории.

## Основной функционал

- Приём входных данных (CSV формат)
- Выбор ML-модели для предсказания. Перед выполнением прогноза пользователь выбирает алгоритм из списка доступных моделей (в зависимости от требуемой точности и скорости расчёта):
  - Логистическая регрессия – базовая модель, работает очень быстро, наименее затратна по ресурсу (низкая стоимость запроса).
  - SVM (Опорные векторы) – модель с более высокой точностью, чем логистическая регрессия, но и с несколько большей стоимостью вычисления.
  - Случайный лес – компромиссный вариант, обеспечивающий хорошую точность при умеренной скорости работы (средняя стоимость).
  - CatBoost – градиентный бустинг на решающих деревьях, даёт максимальную точность прогноза, но работает медленнее остальных (самая высокая стоимость запроса).
- Возврат CSV-файла с предсказанием оттока (1 - пользователь остается, 0 - пользователь уходит)
- Учёт стоимости запроса (система биллинга)
- Хранение транзакций, заказов и баланса пользователя

## Технологический стек

- **Backend-фреймворк:** `Python 3` + `Django 5` с подключением `Django REST Framework` для построения RESTful API.
- **ML-библиотеки:** `scikit-learn` (для моделей логистической регрессии, SVM и случайного леса) и `CatBoost` (для модели градиентного бустинга). Модели предварительно обучены на датасете оттока клиентов (на открытых данных из Kaggle) и сохранены для последующего использования в сервисе.
- **База данных:** `PostgreSQL` для хранения данных о пользователях сервиса, их балансах и проведённых транзакциях/заказах на прогноз.
- **Асинхронные задачи:** `Celery` используется для выполнения тяжёлых вычислительных задач (в частности, расчёта моделей) в фоновом режиме, чтобы не блокировать обработку веб-запросов. В связке с Celery развёрнуты `RabbitMQ` (в качестве брокера очереди задач) и `Redis` (в качестве бекенда для хранения результатов задач и кеширования).
- **Контейнеризация:** для удобства развёртывания используется `Docker`. Конфигурация с несколькими контейнерами описана в `Docker Compose` (сервисы: приложение Django, база данных Postgres, брокер RabbitMQ, хранилище Redis). Это позволяет легко запускать весь стек сервисов командой docker-compose up.
- **Прочее:** Используются инструменты обеспечения качества кода, такие как pre-commit hooks (настройки в репозитории), а зависимости проекта управляются через файл pyproject.toml, используя пакетный менеджер uv.

## Архитектура проекта

Проект реализует модульную архитектуру, разделяя зоны ответственности между несколькими подсистемами.

### Web-API приложение (Django)

Ядро сервиса, обрабатывающее HTTP-запросы (REST API). Основные функции:

- **Регистрация и управление пользователями**
  - Создание аккаунтов
  - Аутентификация и авторизация

- **Управление балансом и транзакциями**
  - Пополнение счёта
  - Просмотр текущего баланса
  - История списаний за предсказания

- **Создание заказов на предсказание (`ServiceOrder`)**
  - Выбор модели
  - Создание заказа

- **Запуск предсказания churn**
  - Принимает данные клиента и `service_order_id` (идентификатор заказа)
  - Инициирует задачу прогнозирования

### Система биллинга (`billing`)

Включает модели и бизнес-логику:

- `Service` – услуга:
  - Название услуги
  - Название модели
  - Стоимость услуги

- `Balance` – баланс пользователя
  - Отдельная модель, связанная с пользователем 1:1

- `Transaction` – учёт операций:
  - Типы: `deposit` (пополнение) и `debit` (списание)
  - Поля: сумма, тип, дата, пользователь

- `ServiceOrder` – заказ на предсказание:
  - Пользователь + выбранный `Service`
  - Цена на момент заказа
  - Ссылка на транзакцию списания
  - Флаг `is_provided` – оказана ли услуга

### ML-часть (`prediction`)

Реализует вычислительную логику:

- **Celery-задача `predict_task`**
  - Загружает модель
  - Применяет к входным данным (из csv-файла)
  - Возвращает результаты (csv-файл)

- **Интеграция с Celery**
  - Очередь: RabbitMQ
  - Хранение состояний и результатов задач: Redis
  - После постановки задачи ServiceOrder помечается как выполненный (`is_provided = True`)
  - Результат доступен после завершения фоновой задачи

### Слой представления (API)

С использованием Django REST Framework:

- **Сериализаторы**
  - `ServiceOrderCreateSerializer` — списывает средства, создаёт `ServiceOrder` и `Transaction` (атомарно)

- **View-классы**
  - Баланс: `RetrieveAPIView`, возвращает текущий баланс
  - Услуги: эндпоинт списка моделей и цен
  - Прогноз: `PredictionAPIView`
    - Принимает `file` и `service_order_id`
    - Проверяет валидность заказа (существует, принадлежит пользователю, не использован)
    - Сохраняет файл
    - Запускает `predict_task`

### Инфраструктура (`docker-compose`)

Объединяет сервисы:

- `api` — Django REST Framework-приложение (Gunicorn)
- `api-celery` - Celery приложение
- `web` - Django-приложение
- `db` — PostgreSQL (БД)
- `redis` — хранилище состояний задач Celery
- `rabbitmq` — брокер сообщений Celery

Ниже представлена упрощённая структура основных директорий и файлов проекта:
```text
ml-service/
├── docker-compose.yml        # Конфигурация всех сервисов Docker
├── packages/
│   └── api/                  # Python-пакет с исходным кодом приложения
│       ├── Dockerfile        # Образ для контейнеров API и Celery
│       ├── pyproject.toml    # Зависимости проекта (uv)
│       ├── static/           # Статические файлы (для Swagger)
│       └── src/
│           └── api/
│               ├── apps/                     # Django-приложения (модули бизнес-логики)
│               │   ├── users/               # Приложение управления пользователями
│               │   │   ├── migrations/…     # Миграции модели User
│               │   │   └── models.py        # Кастомная модель пользователя (расширяет AbstractUser)
│               │   ├── billing/             # Приложение биллинга
│               │   │   ├── migrations/…     # Миграции (Balance, Transaction, Service, ServiceOrder)
│               │   │   ├── models.py        # Модели баланса, транзакций, услуг, заказов
│               │   │   ├── balance/…        # Подмодуль управления балансом (views, serializers, use_cases)
│               │   │   ├── transactions/…   # Подмодуль транзакций (views, serializers, use_cases)
│               │   │   └── service_orders/… # Подмодуль заказов на услуги (views, serializers)
│               │   └── prediction/          # Приложение предсказания оттока
│               │       ├── tasks.py         # Определение Celery-задачи для расчёта модели
│               │       └── views.py         # Представление для приема запроса на прогноз (запуск задачи)
│               ├── delivery/                # Настройки запуска приложения
│               │   ├── asgi.py, wsgi.py     # Точки входа для ASGI/WSGI серверов
│               │   ├── urls.py              # Маршруты URL (подключение маршрутов apps)
│               │   └── gunicorn.conf.py     # конфиг Gunicorn
│               ├── settings.py              # Настройки Django (БД, Celery, установки DRF и пр.)
│               ├── manage.py                # Управление Django-проектом (миграции, запуск сервера и пр.)
│               └── utils.py                 # Утилиты и вспомогательные функции
└── … (прочие файлы репозитория)
```

## Установка и запуск
```
git clone https://github.com/KissedByF1re/ml-service.git
cd ml-service

python -m venv .venv
source .venv/bin/activate

# настройте .env

docker-compose up --build
```

```
# в докер-контейнере с api выполняем
cd api
python manage.py migrate
python manage.py collectstatic

# в докер-контейнере с web выполняем
cd web
python manage.py collectstatic

# Дальнейшие манипуляции и настройку вы можете выполнять непосредственно в IDE и Docker Desktop
```

